<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if cobranca %}Editar Cobrança{% else %}Nova Cobrança{% endif %} - Sistema de Cobrança</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .form-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group label .required {
            color: #f56565;
            margin-left: 3px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .btn-submit {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-submit:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-cancel {
            padding: 12px 30px;
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }

        .btn-cancel:hover {
            background: #cbd5e0;
        }


        /* Custom Datepicker Styles */
        .datepicker-container {
            position: relative;
        }

        .datepicker {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            padding: 15px;
            min-width: 280px;
        }

        .datepicker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .datepicker-nav {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            color: #667eea;
        }

        .datepicker-nav:hover {
            background: #f7fafc;
            border-radius: 4px;
        }

        .datepicker-month-year {
            font-weight: 600;
            color: #4a5568;
        }

        .datepicker-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .datepicker-day-header {
            text-align: center;
            font-weight: 600;
            color: #4a5568;
            padding: 8px 4px;
            font-size: 12px;
        }

        .datepicker-day {
            text-align: center;
            padding: 8px 4px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .datepicker-day:hover {
            background: #f7fafc;
        }

        .datepicker-day.disabled {
            color: #cbd5e0;
            cursor: not-allowed;
            background: #f7fafc;
        }

        .datepicker-day.disabled:hover {
            background: #f7fafc;
        }

        .datepicker-day.today {
            background: #667eea;
            color: white;
        }

        .datepicker-day.selected {
            background: #48bb78;
            color: white;
        }

        .datepicker-day.other-month {
            color: #cbd5e0;
        }

        .datepicker-day.sunday {
            color: #f56565;
            font-weight: bold;
        }

        .datepicker-day.sunday.disabled {
            color: #fed7d7;
            background: #fef5e7;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{% if cobranca %}Editar Cobrança{% else %}Nova Cobrança{% endif %}</h1>
            <a href="{{ url_for('visualizar_cliente', cliente_id=cobranca.cliente_id) if cobranca else url_for('index') }}" class="btn btn-secondary">← Voltar</a>
        </div>

        <div class="form-container">
            <form method="POST" id="cobrancaForm" action="{{ url_for('editar_cobranca', id=cobranca.id) if cobranca else url_for('adicionar_cobranca') }}">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="cliente_id">Cliente <span class="required">*</span></label>
                        {% if cobranca %}
                            <input type="text" value="{{ cliente.nome }}" readonly style="background: #f7fafc; color: #666;">
                            <input type="hidden" name="cliente_id" value="{{ cobranca.cliente_id }}">
                        {% else %}
                            <select id="cliente_id" name="cliente_id" required>
                                <option value="">Selecione um cliente...</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">
                                    {{ cliente.nome }}
                                </option>
                                {% endfor %}
                            </select>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="valor_emprestimo">Valor Emprestado (R$) <span class="required">*</span></label>
                        <input type="number" id="valor_emprestimo" name="valor_emprestimo" step="0.01" min="0.01" 
                               value="{{ cobranca.valor_original if cobranca else '' }}" required>
                    </div>

                    <div class="form-group">
                        <label for="taxa_juros">Taxa de Juros (%) <span class="required">*</span></label>
                        <select id="taxa_juros" name="taxa_juros" class="form-control" required>
                            <option value="" disabled selected>Selecione a taxa de juros</option>
                            <option value="30" {% if cobranca and cobranca.taxa_juros == 30 %}selected{% endif %}>30%</option>
                            <option value="60" {% if cobranca and cobranca.taxa_juros == 60 %}selected{% endif %}>60%</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="valor_devido">Valor Devido (R$) <span class="required">*</span></label>
                        <input type="number" id="valor_devido" name="valor_devido" step="0.01" min="0.01" 
                               value="{{ cobranca.valor_total if cobranca else '' }}" required readonly style="background: #f7fafc; color: #666;">
                    </div>

                    <div class="form-group full-width">
                        <label for="descricao">Descrição</label>
                        {% if cobranca %}
                            <input type="text" id="descricao" name="descricao" 
                                   value="{{ cobranca.descricao if cobranca else '' }}" 
                                   placeholder="Descreva o motivo da cobrança..." readonly style="background: #f7fafc; color: #666;">
                        {% else %}
                            <input type="text" id="descricao" name="descricao" 
                                   value="{{ cobranca.descricao if cobranca else '' }}" 
                                   placeholder="Descreva o motivo da cobrança...">
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="data_vencimento">Data da Primeira Parcela <span class="required">*</span></label>
                        {% if cobranca %}
                            <input type="text" value="{{ cobranca.data_vencimento.strftime('%d/%m/%Y') if cobranca.data_vencimento else '' }}" 
                                   readonly style="background: #f7fafc; color: #666;">
                        {% else %}
                            <div class="datepicker-container">
                                <input type="text" id="data_vencimento" name="data_vencimento" 
                                       value="{{ cobranca.data_vencimento if cobranca else '' }}" 
                                       placeholder="DD-MM-AAAA (domingos não disponíveis)" required readonly>
                                <div id="datepicker" class="datepicker"></div>
                            </div>
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                Domingos não estão disponíveis. As parcelas serão geradas diariamente a partir desta data.
                            </small>
                        {% endif %}
                    </div>

                </div>

                <div class="form-actions">
                    <a href="{{ url_for('visualizar_cliente', cliente_id=cobranca.cliente_id) if cobranca else url_for('index') }}" class="btn-cancel">Cancelar</a>
                    <button type="submit" class="btn-submit">
                        {% if cobranca %}Atualizar Cobrança{% else %}Criar Cobrança{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>

        function calcularValorDevido() {
            const valorEmprestimo = parseFloat(document.getElementById('valor_emprestimo').value) || 0;
            const taxaJuros = parseFloat(document.getElementById('taxa_juros').value) || 0;
            
            if (valorEmprestimo > 0 && taxaJuros > 0) {
                const juros = valorEmprestimo * (taxaJuros / 100);
                const valorDevido = valorEmprestimo + juros;
                document.getElementById('valor_devido').value = valorDevido.toFixed(2);
            } else {
                document.getElementById('valor_devido').value = '';
            }
        }

        // Custom Datepicker Class
        class CustomDatepicker {
            constructor(inputId, datepickerId) {
                this.input = document.getElementById(inputId);
                this.datepicker = document.getElementById(datepickerId);
                this.currentDate = new Date();
                this.selectedDate = null;
                this.monthNames = [
                    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                this.dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                
                this.init();
            }

            init() {
                // Make input clickable to open datepicker
                this.input.addEventListener('click', () => this.toggle());
                
                // Close datepicker when clicking outside
                document.addEventListener('click', (e) => {
                    if (!this.input.contains(e.target) && !this.datepicker.contains(e.target)) {
                        this.hide();
                    }
                });

                // Initialize with current date if no value
                if (!this.input.value) {
                    this.currentDate = new Date();
                } else {
                    // Parse DD-MM-YYYY format
                    const parsedDate = this.parseDateDDMMYYYY(this.input.value);
                    this.currentDate = parsedDate || new Date();
                }

                this.render();
            }

            toggle() {
                if (this.datepicker.style.display === 'none' || this.datepicker.style.display === '') {
                    this.show();
                } else {
                    this.hide();
                }
            }

            show() {
                this.datepicker.style.display = 'block';
                this.datepicker.style.visibility = 'visible';
                // Only render if content is empty or needs update
                if (!this.datepicker.innerHTML.trim()) {
                    this.render();
                }
            }

            hide() {
                this.datepicker.style.display = 'none';
                this.datepicker.style.visibility = 'hidden';
            }

            render() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                
                // Store current visibility state
                const isVisible = this.datepicker.style.display !== 'none';
                
                // Header
                this.datepicker.innerHTML = `
                    <div class="datepicker-header">
                        <button class="datepicker-nav" onclick="datepicker.previousMonth()">‹</button>
                        <div class="datepicker-month-year">${this.monthNames[month]} ${year}</div>
                        <button class="datepicker-nav" onclick="datepicker.nextMonth()">›</button>
                    </div>
                    <div class="datepicker-grid">
                        ${this.dayNames.map(day => `<div class="datepicker-day-header">${day}</div>`).join('')}
                        ${this.renderDays(year, month)}
                    </div>
                `;
                
                // Restore visibility state
                if (isVisible) {
                    this.datepicker.style.display = 'block';
                    this.datepicker.style.visibility = 'visible';
                }
            }

            renderDays(year, month) {
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDayOfWeek = firstDay.getDay();
                
                let days = '';
                
                // Previous month days
                const prevMonth = new Date(year, month - 1, 0);
                for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                    const day = prevMonth.getDate() - i;
                    days += `<div class="datepicker-day other-month">${day}</div>`;
                }
                
                // Current month days
                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const isToday = date.toDateString() === today.toDateString();
                    const isSunday = date.getDay() === 0;
                    const isPast = date < today.setHours(0, 0, 0, 0);
                    const isSelected = this.selectedDate && date.toDateString() === this.selectedDate.toDateString();
                    
                    let classes = 'datepicker-day';
                    if (isToday) classes += ' today';
                    if (isSelected) classes += ' selected';
                    if (isSunday) classes += ' sunday disabled';
                    if (isPast) classes += ' disabled';
                    
                    const clickHandler = (isSunday || isPast) ? '' : `onclick="datepicker.selectDate(${year}, ${month}, ${day})"`;
                    
                    days += `<div class="${classes}" ${clickHandler}>${day}</div>`;
                }
                
                // Next month days
                const remainingDays = 42 - (startingDayOfWeek + daysInMonth);
                for (let day = 1; day <= remainingDays; day++) {
                    days += `<div class="datepicker-day other-month">${day}</div>`;
                }
                
                return days;
            }

            selectDate(year, month, day) {
                const selectedDate = new Date(year, month, day);
                this.selectedDate = selectedDate;
                // Format as DD-MM-YYYY
                const formattedDate = this.formatDateDDMMYYYY(selectedDate);
                this.input.value = formattedDate;
                this.hide();
            }

            formatDateDDMMYYYY(date) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}-${month}-${year}`;
            }

            parseDateDDMMYYYY(dateString) {
                if (!dateString) return null;
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
                    const year = parseInt(parts[2], 10);
                    return new Date(year, month, day);
                }
                return null;
            }

            previousMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                // Just render without changing visibility
                this.render();
            }

            nextMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                // Just render without changing visibility
                this.render();
            }
        }

        // Helper functions for date format conversion
        function parseDateDDMMYYYY(dateString) {
            if (!dateString) return null;
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
                const year = parseInt(parts[2], 10);
                return new Date(year, month, day);
            }
            return null;
        }

        function convertToBackendFormat(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                return `${year}-${month}-${day}`;
            }
            return dateString;
        }

        function convertFromBackendFormat(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const year = parts[0];
                const month = parts[1];
                const day = parts[2];
                return `${day}-${month}-${year}`;
            }
            return dateString;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Convert existing value from backend format to display format
            const dataInput = document.getElementById('data_vencimento');
            if (dataInput.value && dataInput.value.includes('-') && dataInput.value.split('-')[0].length === 4) {
                dataInput.value = convertFromBackendFormat(dataInput.value);
            }

            // Initialize custom datepicker
            window.datepicker = new CustomDatepicker('data_vencimento', 'datepicker');

            // Add event listeners for real-time calculation
            document.getElementById('valor_emprestimo').addEventListener('input', calcularValorDevido);
            
            // Event listener for taxa_juros with automatic date calculation
            document.getElementById('taxa_juros').addEventListener('change', function() {
                // Calculate valor devido
                calcularValorDevido();
                
                // Calculate automatic due date
                const taxaSelecionada = parseInt(this.value);
                let diasParaAdicionar = 0;

                if (taxaSelecionada === 30) {
                    diasParaAdicionar = 10;
                } else if (taxaSelecionada === 60) {
                    diasParaAdicionar = 15;
                }

                if (diasParaAdicionar > 0) {
                    const hoje = new Date();
                    const dataVencimento = new Date(hoje.setDate(hoje.getDate() + diasParaAdicionar));

                    // Ajusta para a segunda-feira se a data final cair em um domingo
                    if (dataVencimento.getDay() === 0) { // 0 = Domingo
                        dataVencimento.setDate(dataVencimento.getDate() + 1);
                    }

                    // Formata a data para o padrão DD-MM-YYYY (formato do datepicker)
                    const dia = String(dataVencimento.getDate()).padStart(2, '0');
                    const mes = String(dataVencimento.getMonth() + 1).padStart(2, '0');
                    const ano = dataVencimento.getFullYear();
                    const dataFormatada = `${dia}-${mes}-${ano}`;

                    // Preenche o campo de data automaticamente
                    document.getElementById('data_vencimento').value = dataFormatada;
                }
            });

            // Validação para impedir domingos como data de vencimento
            if (dataInput) {
                dataInput.addEventListener('change', function() {
                    const dataSelecionada = new Date(this.value + 'T00:00:00'); // Adiciona T00:00 para evitar problemas de fuso

                    // getDay() retorna 0 para Domingo
                    if (dataSelecionada.getDay() === 0) {
                        // Adiciona um dia à data para pular para segunda-feira
                        dataSelecionada.setDate(dataSelecionada.getDate() + 1);

                        // Formata a nova data para YYYY-MM-DD e atualiza o campo
                        const ano = dataSelecionada.getFullYear();
                        const mes = String(dataSelecionada.getMonth() + 1).padStart(2, '0');
                        const dia = String(dataSelecionada.getDate()).padStart(2, '0');
                        this.value = `${ano}-${mes}-${dia}`;

                        // Opcional: Alerta o usuário
                        alert('A data de vencimento não pode ser em um domingo. A data foi ajustada para a segunda-feira seguinte.');
                    }
                });
            }

            // Form validation
            document.getElementById('cobrancaForm').addEventListener('submit', function(e) {
                const clienteId = document.getElementById('cliente_id').value;
                const valorEmprestimo = document.getElementById('valor_emprestimo').value;
                const taxaJuros = document.getElementById('taxa_juros').value;
                const dataVencimento = document.getElementById('data_vencimento').value;

                if (!clienteId) {
                    e.preventDefault();
                    alert('Selecione um cliente!');
                    return;
                }

                if (!valorEmprestimo || parseFloat(valorEmprestimo) <= 0) {
                    e.preventDefault();
                    alert('Valor emprestado deve ser maior que zero!');
                    return;
                }

                if (!taxaJuros) {
                    e.preventDefault();
                    alert('Selecione uma taxa de juros!');
                    return;
                }

                if (!dataVencimento) {
                    e.preventDefault();
                    alert('Data de vencimento é obrigatória!');
                    return;
                }

                // Convert DD-MM-YYYY to YYYY-MM-DD for backend
                const convertedDate = convertToBackendFormat(dataVencimento);
                
                // Check if date is Sunday (additional validation)
                const selectedDate = parseDateDDMMYYYY(dataVencimento);
                if (selectedDate && selectedDate.getDay() === 0) {
                    e.preventDefault();
                    alert('Domingos não são permitidos para data de vencimento. Selecione outro dia.');
                    return;
                }

                // Check if date is not in the past
                const today = new Date();
                const vencimento = parseDateDDMMYYYY(dataVencimento);
                if (vencimento && vencimento < today) {
                    if (!confirm('A data de vencimento está no passado. Deseja continuar?')) {
                        e.preventDefault();
                        return;
                    }
                }

                // Update the input value to backend format before submission
                document.getElementById('data_vencimento').value = convertedDate;
            });
        });
    </script>
</body>
</html>
