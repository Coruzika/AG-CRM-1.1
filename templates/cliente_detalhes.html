<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ cliente.nome }} - Sistema de Cobran√ßa</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        /* Flexbox utilities */
        .d-flex {
            display: flex;
        }

        .align-items-center {
            align-items: center;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .mb-4 {
            margin-bottom: 1.5rem;
        }

        .mr-3 {
            margin-right: 1rem;
        }

        .btn-outline-secondary {
            background: transparent;
            color: #6c757d;
            border: 1px solid #6c757d;
            padding: 8px 12px;
            border-radius: 5px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .btn-outline-secondary:hover {
            background: #6c757d;
            color: white;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: 1px solid #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
            border-color: #bd2130;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            line-height: 1.5;
            border-radius: 4px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .info-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .info-item {
            margin-bottom: 10px;
        }

        .info-label {
            font-weight: 600;
            color: #4a5568;
        }

        .info-value {
            color: #666;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-header {
            padding: 20px 25px;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .table-header h2 {
            color: #333;
            font-size: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        tr:hover {
            background: #f7fafc;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge.pending {
            background: #fed7d7;
            color: #c53030;
        }

        .badge.paid {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge.overdue {
            background: #feebc8;
            color: #7c2d12;
        }

        .btn-sm {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-decoration: none;
            display: inline-block;
            margin-right: 5px;
        }

        .btn-sm.pay {
            background: #48bb78;
            color: white;
        }

        .btn-sm.cancel {
            background: #f56565;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center">
                    <a href="{{ url_for('index') }}" class="btn btn-secondary btn-sm mr-3" title="Voltar ao In√≠cio">
                        <i class="fas fa-home"></i> In√≠cio
                    </a>
                    <h1>Detalhes de {{ cliente.nome }}</h1>
                </div>
                <div>
                    <a href="{{ url_for('editar_cliente', cliente_id=cliente.id) }}" class="btn btn-primary">Editar Cliente</a>
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#excluirModal">Excluir</button>
                </div>
            </div>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <h3>Informa√ß√µes Pessoais</h3>
                <div class="info-item">
                    <span class="info-label">Nome:</span>
                    <span class="info-value">{{ cliente.nome }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">CPF/CNPJ:</span>
                    <span class="info-value">{{ cliente.cpf_cnpj or 'N√£o informado' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Empresa:</span>
                    <span class="info-value">{{ cliente.empresa }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">RG:</span>
                    <span class="info-value">{{ cliente.rg or 'N√£o informado' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">E-mail:</span>
                    <span class="info-value">{{ cliente.email or 'N√£o informado' }}</span>
                </div>
            </div>

            <div class="info-card">
                <h3>Contato</h3>
                <div class="info-item">
                    <span class="info-label">Telefone:</span>
                    <span class="info-value">{{ cliente.telefone or 'N√£o informado' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Telefone Secund√°rio:</span>
                    <span class="info-value">{{ cliente.telefone_secundario or 'N√£o informado' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Chave Pix:</span>
                    <span class="info-value">{{ cliente.chave_pix or 'N√£o informado' }}</span>
                </div>
            </div>

            <div class="info-card">
                <h3>Refer√™ncia</h3>
                <div class="info-item">
                    <span class="info-label">Nome da Refer√™ncia:</span>
                    <span class="info-value">{{ cliente.referencia or 'N√£o informado' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Telefone da Refer√™ncia:</span>
                    <span class="info-value">{{ cliente.telefone_referencia or 'N√£o informado' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Endere√ßo da Refer√™ncia:</span>
                    <span class="info-value">{{ cliente.endereco_referencia or 'N√£o informado' }}</span>
                </div>
            </div>

            <div class="info-card">
                <h3>Endere√ßo</h3>
                <div class="info-item">
                    <span class="info-label">Endere√ßo:</span>
                    <span class="info-value">{{ cliente.endereco or 'N√£o informado' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Cidade/Estado:</span>
                    <span class="info-value">
                        {% if cliente.cidade or cliente.estado %}
                            {% if cliente.cidade %}{{ cliente.cidade }}{% endif %}
                            {% if cliente.cidade and cliente.estado %} - {% endif %}
                            {% if cliente.estado %}{{ cliente.estado }}{% endif %}
                        {% else %}
                            N√£o informado
                        {% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">CEP:</span>
                    <span class="info-value">{{ cliente.cep or 'N√£o informado' }}</span>
                </div>
            </div>
        </div>

        {% if cliente.observacoes %}
        <div class="info-card" style="margin-bottom: 30px;">
            <h3>Observa√ß√µes</h3>
            <p>{{ cliente.observacoes }}</p>
        </div>
        {% endif %}

        <div class="table-container">
            <div class="table-header">
                <h2>Cobran√ßas</h2>
            </div>
            {% if cobrancas %}
            <table>
                <thead>
                    <tr>
                        <th>Descri√ß√£o</th>
                        <th>Valor Original</th>
                        <th>Total Pago</th>
                        <th>Multa</th>
                        <th>Saldo Devedor</th>
                        <th>Vencimento</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cobranca in cobrancas %}
                    <tr class="{% if cobranca.status == 'Pago' %}table-success{% elif cobranca.data_vencimento < today %}table-danger{% endif %}">
                        <td>{{ cobranca.descricao or 'Sem descri√ß√£o' }}</td>
                        <td>R$ {{ "{:,.2f}".format(cobranca.valor_original).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                        <td>R$ {{ "{:,.2f}".format(cobranca.valor_pago or 0).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                        <td>
                            R$ {{ "{:,.2f}".format(cobranca.multa_aplicada).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                        </td>
                        <td><strong style="color: {% if cobranca.saldo_devedor_calculado > 0 %}#dc2626{% else %}#059669{% endif %};">R$ {{ "{:,.2f}".format(cobranca.saldo_devedor_calculado).replace(',', 'X').replace('.', ',').replace('X', '.') }}</strong></td>
                        <td>{{ cobranca.data_vencimento.strftime('%d/%m/%Y') }}</td>
                        <td>
                            {% if cobranca.status == 'Pago' %}
                                <span class="badge paid">Pago</span>
                            {% elif cobranca.status == 'Pendente' %}
                                <span class="badge pending">Pendente</span>
                            {% else %}
                                <span class="badge overdue">{{ cobranca.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if cobranca.tipo_cobranca == 'Parcelada' %}
                                <button class="btn-sm" type="button" onclick="toggleParcelas({{ cobranca.id }})" style="background: #3b82f6; color: white; text-decoration: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-right: 5px; border: none; cursor: pointer;">
                                    Ver Parcelas ({{ cobranca.parcelas_com_multa|length if cobranca.parcelas_com_multa else 0 }})
                                </button>
                            {% endif %}
                            <a href="{{ url_for('visualizar_pagamentos_cobranca', cobranca_id=cobranca.id) }}" class="btn-sm" style="background: #3b82f6; color: white; text-decoration: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-right: 5px;">Ver Pagamentos</a>
                            {% if cobranca.status != 'Pago' %}
                            <a href="{{ url_for('editar_cobranca', id=cobranca.id) }}" class="btn-sm" style="background: #667eea; color: white; text-decoration: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-right: 5px;">Editar</a>
                            <button onclick="openPaymentModal({{ cobranca.id }}, '{{ cliente.nome }}', {{ cobranca.total_a_pagar }})" class="btn-sm pay">Pagar</button>
                            <form action="{{ url_for('cancelar_cobranca', cobranca_id=cobranca.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Deseja cancelar esta cobran√ßa?');">
                                <button type="submit" class="btn-sm cancel">Cancelar</button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% if cobranca.tipo_cobranca == 'Parcelada' %}
                    <tr id="parcelas-{{ cobranca.id }}" style="display: none;">
                        <td colspan="8" style="padding: 0;">
                            <div style="background: #f8f9fa; padding: 20px; border-left: 4px solid #3b82f6;">
                                <h6 style="margin-bottom: 15px; color: #333; font-size: 16px;">üìã Detalhes das Parcelas</h6>
                                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <thead style="background: #e9ecef;">
                                        <tr>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">#</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Vencimento</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Valor Original</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Multa Manual</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Valor Total</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">Status</th>
                                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6;">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for parcela_data in cobranca.parcelas_com_multa %}
                                        <tr style="{% if parcela_data.status == 'Pago' %}background-color: #d4edda;{% elif parcela_data.vencimento < today %}background-color: #f8d7da;{% endif %}">
                                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">{{ parcela_data.numero }}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">{{ parcela_data.vencimento.strftime('%d/%m/%Y') }}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">
                                                R$ {{ "{:,.2f}".format(parcela_data.valor_original).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">
                                                R$ {{ "{:,.2f}".format(parcela_data.multa_manual).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">
                                                R$ {{ "{:,.2f}".format(parcela_data.valor_atualizado).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">
                                                {% if parcela_data.status == 'Pago' %}
                                                    <span class="badge paid">‚úÖ Pago</span>
                                                {% else %}
                                                    <span class="badge pending">‚è≥ Pendente</span>
                                                {% endif %}
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: center;">
                                                {% if parcela_data.status != 'Pago' %}
                                                <form action="{{ url_for('marcar_parcela_paga', id=parcela_data.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Confirmar pagamento da parcela {{ parcela_data.numero }}?');">
                                                    <button type="submit" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500; margin-right: 5px;">
                                                        üí∞ Pagar
                                                    </button>
                                                </form>
                                                <button type="button" class="btn btn-warning btn-xs ml-1" data-bs-toggle="modal" data-bs-target="#editarMultaParcelaModal"
                                                        data-parcela-id="{{ parcela_data.id }}"
                                                        data-parcela-num="{{ parcela_data.numero }}"
                                                        data-multa-atual="{{ parcela_data.multa_manual or '' }}"
                                                        style="padding: 6px 12px; font-size: 12px; margin-left: 5px;">
                                                    <i class="fas fa-pencil-alt"></i> Multa
                                                </button>
                                                <button type="button" class="btn btn-info btn-xs ml-1" data-bs-toggle="modal" data-bs-target="#editarDataParcelaModal"
                                                        data-parcela-id="{{ parcela_data.id }}"
                                                        data-parcela-num="{{ parcela_data.numero }}"
                                                        data-vencimento-atual="{{ parcela_data.vencimento.strftime('%Y-%m-%d') }}"
                                                        style="padding: 6px 12px; font-size: 12px; margin-left: 5px;">
                                                    <i class="fas fa-calendar-alt"></i> Data
                                                </button>
                                                {% else %}
                                                    <span style="color: #28a745; font-weight: 600; font-size: 12px;">‚úì Pago</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <p>Nenhuma cobran√ßa encontrada para este cliente.</p>
            </div>
            {% endif %}
        </div>

        {% if historico %}
        <div class="table-container">
            <div class="table-header">
                <h2>Hist√≥rico de Pagamentos</h2>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Cobran√ßa</th>
                        <th>Valor Pago</th>
                        <th>Forma de Pagamento</th>
                        <th>Observa√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pagamento in historico %}
                    <tr>
                        <td>{{ pagamento.data_pagamento.strftime('%d/%m/%Y') }}</td>
                        <td>{{ pagamento.cobranca_descricao or 'Sem descri√ß√£o' }}</td>
                        <td>R$ {{ "{:,.2f}".format(pagamento.valor_pago).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                        <td>{{ pagamento.forma_pagamento }}</td>
                        <td>{{ pagamento.observacoes or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <div class="table-container">
            <div class="table-header">
                <h2>Documentos Anexados</h2>
            </div>
            <div class="row g-3 p-3">
                {% if documentos and documentos|length > 0 %}
                    {% for doc in documentos %}
                    <div class="col-md-4 col-sm-6 mb-3 text-center">
                    <div class="card h-100">
                        <a href="{{ url_for('uploaded_file', cliente_id=cliente.id, filename=doc.nome_ficheiro) }}" target="_blank" title="Clique para ver o ficheiro original">

                            {# Verifica a extens√£o do ficheiro (em min√∫sculas) #}
                            {% set extension = doc.nome_ficheiro.split('.')[-1].lower() %}

                            {% if extension in ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'] %}
                                <img src="{{ url_for('uploaded_file', cliente_id=cliente.id, filename=doc.nome_ficheiro) }}" 
                                     class="card-img-top p-2" 
                                     alt="{{ doc.nome_ficheiro }}" 
                                     style="max-height: 200px; object-fit: contain;"
                                     onerror="this.style.display='none'; this.onerror=null;"> 
                            {% else %}
                                <div class="card-body text-center py-5">
                                    <i class="fas fa-file-alt fa-3x text-muted"></i> 
                                </div>
                            {% endif %}
                        </a>
                        <div class="card-footer bg-light">
                            <small class="text-muted" style="word-wrap: break-word;">{{ doc.nome_ficheiro }}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col">
                    <p>Nenhum documento anexado.</p>
                </div>
            {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal Editar Multa da Parcela -->
    <div class="modal fade" id="editarMultaParcelaModal" tabindex="-1" role="dialog" aria-labelledby="editarMultaParcelaModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editarMultaParcelaModalLabel">Editar Multa da Parcela</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editarMultaParcelaForm" method="POST" action="">
                    <div class="modal-body">
                        <p>Parcela N¬∫: <strong id="editMultaParcelaNum"></strong></p>
                        <div class="form-group">
                            <label for="multa_manual_parcela_input">Valor da Multa Manual (R$)</label>
                            <input type="number" step="0.01" class="form-control" id="multa_manual_parcela_input" name="multa_manual_parcela" placeholder="Insira o valor ou deixe em branco para zerar">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">Salvar Multa</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Editar Data de Vencimento da Parcela -->
    <div class="modal fade" id="editarDataParcelaModal" tabindex="-1" role="dialog" aria-labelledby="editarDataParcelaModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editarDataParcelaModalLabel">Editar Data de Vencimento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editarDataParcelaForm" method="POST" action="">
                    <div class="modal-body">
                        <p>Parcela N¬∫: <strong id="editDataParcelaNum"></strong></p>
                        <div class="form-group">
                            <label for="nova_data_vencimento_input">Nova Data de Vencimento</label>
                            <input type="date" class="form-control" id="nova_data_vencimento_input" name="nova_data_vencimento" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-info">Salvar Nova Data</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Pagamento -->
    <div id="pagamentoModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content" style="background-color: white; margin: 5% auto; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 5px 25px rgba(0,0,0,0.2);">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #333;">Registrar Pagamento</h2>
                <span class="close" onclick="closeModal('pagamentoModal')" style="font-size: 28px; font-weight: bold; cursor: pointer; color: #999;">&times;</span>
            </div>
            <form id="pagamentoForm" method="POST" action="">
                <div style="margin-bottom: 20px;">
                    <p>Cobran√ßa ID: <strong id="pagamentoCobrancaId"></strong></p>
                    <p>Valor Total Devido (com multas): <strong id="pagamentoValorTotal"></strong></p>
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="valor_pago" style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 500;">Valor a Pagar (R$) *</label>
                    <input type="number" step="0.01" class="form-control" id="valor_pago" name="valor_pago" required>
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="observacao_pagamento" style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 500;">Observa√ß√£o (Opcional)</label>
                    <textarea class="form-control" id="observacao_pagamento" name="observacao_pagamento" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                    <button type="button" onclick="closeModal('pagamentoModal')" style="padding: 10px 25px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Cancelar</button>
                    <button type="submit" style="padding: 10px 25px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Registrar Pagamento</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const pagamentoForm = document.getElementById('pagamentoForm');

            if (pagamentoForm) {
                pagamentoForm.addEventListener('submit', function() {
                    // Encontra o bot√£o de submiss√£o dentro do formul√°rio
                    const submitButton = pagamentoForm.querySelector('button[type="submit"]');

                    if (submitButton) {
                        // Desativa o bot√£o
                        submitButton.disabled = true;

                        // Altera o texto para dar feedback ao utilizador
                        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> A processar...';
                    }
                });
            }
        });

        function openPaymentModal(cobrancaId, clienteNome, valorTotal) {
            document.getElementById('pagamentoModal').style.display = "block";
            document.getElementById('pagamentoCobrancaId').textContent = cobrancaId;
            document.getElementById('pagamentoValorTotal').textContent = `R$ ${valorTotal.toFixed(2).replace('.', ',')}`;
            
            var form = document.getElementById('pagamentoForm');
            form.action = `/cobranca/${cobrancaId}/registrar_pagamento`;
            
            // Sugere o valor total no campo de pagamento
            document.getElementById('valor_pago').value = valorTotal;
            
            // Reativa o bot√£o quando o modal √© aberto (caso tenha sido desativado anteriormente)
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Registrar Pagamento';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = "none";
            }
        }

        function toggleParcelas(cobrancaId) {
            const parcelasRow = document.getElementById('parcelas-' + cobrancaId);
            const button = event.target;
            
            if (parcelasRow.style.display === 'none' || parcelasRow.style.display === '') {
                parcelasRow.style.display = 'table-row';
                button.innerHTML = button.innerHTML.replace('Ver Parcelas', 'Ocultar Parcelas');
                button.style.background = '#dc3545';
            } else {
                parcelasRow.style.display = 'none';
                button.innerHTML = button.innerHTML.replace('Ocultar Parcelas', 'Ver Parcelas');
                button.style.background = '#3b82f6';
            }
        }

        // JavaScript para o modal de edi√ß√£o de multa da parcela
        document.addEventListener('DOMContentLoaded', function() {
            const editarMultaParcelaModal = document.getElementById('editarMultaParcelaModal');
            
            if (editarMultaParcelaModal) {
                editarMultaParcelaModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    var parcelaId = button.getAttribute('data-parcela-id');
                    var parcelaNum = button.getAttribute('data-parcela-num');
                    var multaAtual = button.getAttribute('data-multa-atual');

                    document.getElementById('editMultaParcelaNum').textContent = parcelaNum;
                    document.getElementById('multa_manual_parcela_input').value = multaAtual;

                    // Define a action do formul√°rio dinamicamente
                    var form = document.getElementById('editarMultaParcelaForm');
                    form.action = '/parcela/' + parcelaId + '/editar_multa';
                });
            }

            // JavaScript para o modal de edi√ß√£o de data da parcela
            const editarDataParcelaModal = document.getElementById('editarDataParcelaModal');
            
            if (editarDataParcelaModal) {
                editarDataParcelaModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    var parcelaId = button.getAttribute('data-parcela-id');
                    var parcelaNum = button.getAttribute('data-parcela-num');
                    var vencimentoAtual = button.getAttribute('data-vencimento-atual');

                    document.getElementById('editDataParcelaNum').textContent = parcelaNum;
                    document.getElementById('nova_data_vencimento_input').value = vencimentoAtual;

                    // Define a action do formul√°rio dinamicamente
                    var form = document.getElementById('editarDataParcelaForm');
                    form.action = '/parcela/' + parcelaId + '/editar_data';
                });
            }
        });
    </script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
